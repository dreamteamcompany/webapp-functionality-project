# Контекстная память виртуального пациента

## Описание

Виртуальный AI-пациент теперь имеет **долговременную память диалога**, которая сохраняется в `localStorage` браузера. Это позволяет пациенту:

1. **Помнить всю историю разговора** между сессиями
2. **Анализировать паттерны поведения** администратора
3. **Давать контекстуально релевантные ответы** на основе предыдущих сообщений
4. **Отслеживать эмоциональную динамику** диалога

## Как это работает

### Сохранение истории

При каждом ответе пациента вся история диалога автоматически сохраняется в `localStorage` под ключом `history`:

```typescript
localStorage.setItem('history', JSON.stringify({
  sessionId: string,
  conversationHistory: Array<{role, content}>,
  currentSatisfaction: number,
  currentEmotionalState: string,
  context: {
    topicsDiscussed: string[],
    emotionalJourney: string[],
    empathyShown: number,
    questionsAsked: number,
    clarityLevel: number,
    keyMoments: KeyMoment[],
    trustBuilding: number[],
    anxietyLevels: number[],
    adminMistakes: string[],
    adminSuccesses: string[]
  },
  timestamp: number
}));
```

### Загрузка истории

При открытии диалога с пациентом:
1. Система проверяет наличие истории в `localStorage`
2. Если история существует и не старше **24 часов**, она загружается
3. Пациент продолжает диалог с учётом всего контекста предыдущих сообщений
4. Если истории нет или она устарела, начинается новый диалог

### Очистка истории

Кнопка **"Начать заново"** позволяет:
- Очистить историю из `localStorage`
- Сбросить состояние пациента
- Начать новый диалог с новым приветствием

## Контекстный анализ ответов

Пациент анализирует ответы администратора по следующим критериям:

### 1. Эмпатия
- Обнаружение фраз сочувствия: "понимаю", "переживаете", "волнуетесь"
- Отслеживание количества проявленной эмпатии
- Влияние на удовлетворённость: **+15 баллов**

### 2. Задавание вопросов
- Обнаружение вопросительных слов и знаков
- Подсчёт количества заданных вопросов
- Влияние на удовлетворённость: **+10 баллов**

### 3. Простота объяснений
- Обнаружение фраз: "простыми словами", "попроще", "без терминов"
- Отслеживание использования медицинских терминов
- Влияние на удовлетворённость: **+10 баллов** (простые) / **-20 баллов** (сложные термины)

### 4. Тональность
- Позитивная: **+5 баллов**
- Негативная: **-10 баллов**

### 5. Длина и качество ответа
- Бессмысленные ответы: **-25 баллов**
- Слишком короткие ответы: **-12 баллов**
- Быстрое качественное решение (≤6 сообщений): **+20 баллов**

## Эмоциональные состояния

Пациент меняет эмоциональное состояние в зависимости от качества общения:

```
scared → nervous → calm → relieved → happy
  ↓         ↓        ↓
confused   sad    angry
```

### Переходы:
- **Эмпатия (2+ раза)**: scared → nervous → calm
- **Сложная терминология**: calm/nervous → confused
- **Высокая ясность**: confused → calm
- **Длительный успешный диалог (>8 сообщений, >75% удовлетворённости)**: → happy
- **Длительный неуспешный диалог (>8 сообщений, <40% удовлетворённости)**: → angry

## Ключевые моменты диалога

Система отслеживает важные события:

```typescript
interface KeyMoment {
  turn: number;                    // Номер хода
  what: string;                    // Описание события
  impact: 'positive' | 'negative' | 'neutral';
  satisfactionChange: number;      // Изменение удовлетворённости
}
```

Примеры ключевых моментов:
- "Проявлена эмпатия к пациенту" (+12)
- "Объяснение простым языком" (+8)
- "Использована сложная терминология" (-15)
- "Холодный или негативный тон" (-10)
- "Быстрое и качественное решение" (+20)

## Генерация ответов

### Система случайных возражений (25% шанс)
Как в симуляторе продаж, пациент может внезапно высказать сомнение:

- **Сомнение в цене**: "Может, есть что-то попроще?"
- **Сомнение во времени**: "Это займёт больше времени?"
- **Сомнение в доверии**: "Откуда такая уверенность?"
- **Поиск альтернатив**: "Может, попробовать народное средство?"
- **Страх**: "А вдруг не поможет?"
- **Прокрастинация**: "Мне нужно подумать..."

### Прямое цитирование
Пациент цитирует конкретные фразы администратора:

```typescript
// Если назвали цену
"Так, 5000 рублей... Это много для меня."

// Если назвали срок
"2 недели? Это довольно долго..."

// Если сказали "гарантируем"
"Вы гарантируете? Это важно."
```

### Обнаружение противоречий
Если администратор противоречит сам себе:

```typescript
// Сначала: "Это недорого"
// Потом: "Да, это дорогая процедура"
→ "Подождите, вы сначала говорили что недорого..."
```

## API методы

### AdvancedPatientAI

```typescript
// Получение ответа с автосохранением
async getResponse(userMessage: string): Promise<AIResponse>

// Очистка истории
clearHistory(): void

// Получение истории
getConversationHistory(): Array<{role, content}>

// Получение текущего состояния
getCurrentSatisfaction(): number
getCurrentEmotionalState(): string

// Анализ диалога
analyzeConversation(): ConversationAnalysis
```

## Пример использования

```typescript
// Создание AI пациента (автоматически загружает историю)
const ai = new AdvancedPatientAI(scenario);

// Получение сообщений
const history = ai.getConversationHistory();
if (history.length > 0) {
  // История загружена, продолжаем диалог
  setMessages(history);
} else {
  // Новый диалог
  const greeting = ai.getGreeting();
  setMessages([{ role: 'ai', content: greeting }]);
}

// Отправка сообщения (автоматически сохраняется)
const response = await ai.getResponse(userMessage);

// Очистка истории
ai.clearHistory();
```

## Хранение данных

### Срок действия
История автоматически удаляется через **24 часа** с момента последнего сохранения.

### Размер данных
Примерный размер одной истории диалога: **10-50 KB**

### Ограничения localStorage
Большинство браузеров поддерживают до **5-10 MB** на домен.

## Отладка

Для просмотра сохранённой истории:

```javascript
// В консоли браузера
const history = JSON.parse(localStorage.getItem('history'));
console.log(history);
```

Для очистки вручную:

```javascript
localStorage.removeItem('history');
```
