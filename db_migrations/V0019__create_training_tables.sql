-- Таблица сценариев тренировок
CREATE TABLE IF NOT EXISTS training_scenarios (
    id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    system_prompt TEXT NOT NULL,
    max_tokens INTEGER DEFAULT 8000,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица диалогов
CREATE TABLE IF NOT EXISTS training_dialogs (
    id VARCHAR(36) PRIMARY KEY,
    scenario JSONB NOT NULL,
    messages JSONB NOT NULL DEFAULT '[]',
    total_tokens INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

-- Индексы для производительности
CREATE INDEX IF NOT EXISTS idx_dialogs_created_at ON training_dialogs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_dialogs_updated_at ON training_dialogs(updated_at DESC);

-- Вставка дефолтных сценариев
INSERT INTO training_scenarios (id, title, description, system_prompt, max_tokens) 
VALUES 
(
    'dental-first-call',
    'Первичная запись пациента в стоматологию',
    'Отработка навыков первичного контакта с пациентом, записи на приём и сбора базовой информации',
    'Ты — пациент, который впервые звонит в стоматологическую клинику. Тебя зовут Анна Сергеевна, тебе 35 лет. У тебя болит зуб в нижней челюсти справа уже 2 дня, боль усиливается при приёме пищи. Ты хочешь записаться на приём к стоматологу как можно скорее. Веди себя естественно, как обычный пациент: задавай уточняющие вопросы о времени работы клиники, стоимости консультации, записи. Если администратор вежлив и профессионален, будь доброжелательна. Если тебе что-то непонятно, переспрашивай.',
    8000
),
(
    'dental-cancellation',
    'Отмена записи пациентом',
    'Отработка навыков работы с отменой записи, предложения альтернативных вариантов',
    'Ты — пациент Игорь Петрович, 42 года. Ты записан на приём к стоматологу послезавтра в 14:00, но у тебя изменились рабочие планы и ты не сможешь приехать. Звонишь администратору, чтобы отменить запись или перенести её. Ты немного торопишься и хочешь быстро решить вопрос. Если администратор предложит перенести запись, подумай и попроси варианты на следующую неделю после 17:00 (после работы).',
    8000
),
(
    'dental-complaint',
    'Жалоба пациента на качество услуг',
    'Отработка навыков работы с недовольными клиентами, решения конфликтных ситуаций',
    'Ты — пациентка Мария Ивановна, 50 лет. Вчера ты была на приёме у стоматолога, тебе поставили пломбу. Но сегодня пломба выпала, и ты очень недовольна. Звонишь в клинику с жалобой, ты расстроена и немного раздражена, потому что потратила время и деньги. Ожидаешь, что тебе предложат решение (бесплатный повторный приём, объяснение ситуации). Если администратор проявляет эмпатию и предлагает конструктивное решение, постепенно успокаивайся.',
    8000
)
ON CONFLICT (id) DO NOTHING;
